function paper(e){this.setting_=e,this.baseUrl_="",void 0!=e.baseUrl&&(this.baseUrl_=e.baseUrl),this.canvas_=null,this.context_=null,this.state_=0,this.statePrev_=0,this.step_=!1,this.execStep_=!1,this.checkLoading_=!1,this.loadingCount_=0,this.loadedCount_=0,this.errorMessage_="",this.images_=null,this.imageScale_=1,this.vertices_=null,this.verticesOuter_=null,this.verticesLeft_=null,this.verticesRight_=null,this.verticesDir_=null,this.verticesMouse_=null,this.mouseOff_=!0,this.radiusRatio_=1,this.namiImages_=null,this.mouseCurve_={points:null,curve:null,create:function(){var e=this.points,t=new CubicCurve;t.create(e);var i=new Point(t.calcX(.02)-t.calcX(0),t.calcY(.02)-t.calcY(0));i.normalize();var s=new Point(e[1].x-e[0].x,e[1].y-e[0].y).getLength(),h=new Point(t.calcX(t.vertices_.length-1)-t.calcX(t.vertices_.length-1-.02),t.calcY(t.vertices_.length-1)-t.calcY(t.vertices_.length-1-.02));h.normalize();var r=new Point(e[2].x-e[1].x,e[2].y-e[1].y).getLength(),a=new Array;a.push(new Point(e[0].x-i.x*s/3,e[0].y-i.y*s/3));for(var n=0;n<e.length;n++)a.push(e[n]);a.push(new Point(e[e.length-1].x+h.x*r/3,e[e.length-1].y+h.y*r/3)),t.create(a),this.curve=t}},this.debugMove_=-1,this.debugDrawTimer_=0,this.gifEncoder_=null,this.movEncoder_=null,this.encodeTimer_=0,this.encodeDuration_=48}paper.prototype.Initialize=function(e,t,i,s){this.canvas_=e.canvas_,this.context_=this.canvas_.getContext("2d"),e.setUrl(""),this.checkLoading_=!0,this.images_=new Array;for(var h=0;h<Setting.images.length;h++){var r=new mgImage;r.setup(document.images["anime"+h]),r.offset=Setting.images[h].offset,this.images_.push(r)}this.namiImages_=new Array;for(var h=0;4>h;h++){var r=new mgImage;r.setup(document.images["nami"+(h+1)]),this.namiImages_.push(r)}this.vertices_=new Array,this.verticesOuter_=new Array,this.verticesLeft_=new Array,this.verticesRight_=new Array,this.verticesDir_=new Array,this.verticesMouse_=new Array,this.mouseCurve_.points=new Array,this.mouseCurve_.points.push(new Point(10,2*i/5)),this.mouseCurve_.points.push(new Point(t/2,2*i/5)),this.mouseCurve_.points.push(new Point(t-10,4*i/5))},paper.prototype.IsLoading=function(){if(!this.checkLoading_)return!1;for(var e=!0,t=0;t<this.images_.length;t++)this.images_[t].isLoading()&&(e=!1);if(e){if("twitter"===this.setting_.compressType){var i=this.images_[0].img_.width*this.images_[0].img_.height;i>27e4&&(this.imageScale_=Math.sqrt(27e4/i))}else"tumblr"===this.setting_.compressType&&(this.images_[0].img_.width<=this.images_[0].img_.height&&500<this.images_[0].img_.height?this.imageScale_=500/this.images_[0].img_.height:this.images_[0].img_.height<=this.images_[0].img_.width&&500<this.images_[0].img_.width&&(this.imageScale_=500/this.images_[0].img_.width));if(void 0!=this.setting_.sizeType)for(var s=[.7,.8,.9,1,1.1,1.2,1.3],t=0;t<s.length;t++)if(this.setting_.sizeType==t){this.imageScale_*=s[t];break}return this.encodeTimer_=this.encodeDuration_,this.checkLoading_=!1,!1}return!0},paper.prototype.Execute=function(){if(null!=this.canvas_){var e=this.canvas_.width;this.canvas_.height;if(0==this.state_)this.IsLoading()||(this.state_=1);else if(mgMouse.on()||this.encodeTimer_>0){this.mouseOff_&&this.Callback("reset");var t=mgMouse.x,i=mgMouse.y;if(this.encodeTimer_>0){var s=1-this.encodeTimer_/this.encodeDuration_;t=this.mouseCurve_.curve.calcX(this.mouseCurve_.curve.vertices_.length*s),i=this.mouseCurve_.curve.calcY(this.mouseCurve_.curve.vertices_.length*s)}var h=0;if(this.verticesMouse_.length>0){var r=this.verticesMouse_[this.verticesMouse_.length-1];h=(t-r.x)*(t-r.x)+(i-r.y)*(i-r.y)}if((this.verticesMouse_.length<=0||h>49)&&(this.verticesMouse_.push({x:t,y:i}),this.verticesMouse_.length>=2)){var a=this.verticesMouse_[this.verticesMouse_.length-2],n=this.verticesMouse_[this.verticesMouse_.length-1],o=new Point(n.x-a.x,n.y-a.y),_=o.getLength(),g=o.getNormalize(),l=new Point(g.y,-g.x),c=_*(1.2+.5*Math.random())*this.radiusRatio_,u=_*(1.2+.5*Math.random())*this.radiusRatio_;this.verticesLeft_.push(new Point(n.x-l.x*c,n.y-l.y*c)),this.verticesRight_.push(new Point(n.x+l.x*u,n.y+l.y*u));var v=1+9*Math.random();this.verticesDir_.push(new Point(l.x*v,l.y*v)),this.vertices_.length=0,this.vertices_.push(this.verticesMouse_[0]);for(var m=0;m<this.verticesLeft_.length;m++){var f=this.verticesLeft_[m];this.vertices_.push(f)}this.vertices_.push(new Point(n.x+g.x*_*.75,n.y+g.y*_*.75));for(var m=0;m<this.verticesRight_.length;m++){var f=this.verticesRight_[this.verticesRight_.length-1-m];this.vertices_.push(f)}this.verticesOuter_.length=0,this.verticesOuter_.push(this.verticesMouse_[0]);for(var m=0;m<this.verticesLeft_.length;m++){var f=new Point(this.verticesLeft_[m].x-this.verticesDir_[m].x,this.verticesLeft_[m].y-this.verticesDir_[m].y);this.verticesOuter_.push(f)}this.verticesOuter_.push(new Point(n.x+g.x*_*1.5,n.y+g.y*_*1.5));for(var m=0;m<this.verticesRight_.length;m++){var f=new Point(this.verticesRight_[this.verticesRight_.length-1-m].x+this.verticesDir_[this.verticesRight_.length-1-m].x,this.verticesRight_[this.verticesRight_.length-1-m].y+this.verticesDir_[this.verticesRight_.length-1-m].y);this.verticesOuter_.push(f)}}}else this.mouseOff_=!0;if(mgMouse.isPreventDefault?mgMouse.isPreventDefault=mgMouse.on():mgMouse.isPreventDefault=mgMouse.on()&&mgMouse.getDontMoveCount()>3,this.debugMove_<0&&mgMouse.on()){for(var m=0;m<this.mouseCurve_.points.length;m++){var d=this.mouseCurve_.points[m];if(d.x-10<=mgMouse.x&&mgMouse.x<=d.x+10&&d.y-10<=mgMouse.y&&mgMouse.y<=d.y+10){this.debugMove_=m;break}}if(this.debugMove_<0){var y=20,p=200,x=e-y-10,M=50;x<=mgMouse.x&&mgMouse.x<=x+y&&M<=mgMouse.y&&mgMouse.y<=M+p&&(this.debugMove_=this.mouseCurve_.points.length)}}else if(0<=this.debugMove_&&this.debugMove_<this.mouseCurve_.points.length)if(mgMouse.on()){var d=this.mouseCurve_.points[this.debugMove_];d.x=mgMouse.x,d.y=mgMouse.y}else this.debugMove_=-1;else if(this.debugMove_==this.mouseCurve_.points.length)if(mgMouse.on()){var p=200,M=50;this.radiusRatio_=Math.min(Math.max(2*(1-(mgMouse.y-M)/p),.25),2)}else this.debugMove_=-1}},paper.prototype.Draw=function(e){if(null!=this.canvas_){var t=this.canvas_.width,i=this.canvas_.height;if(this.context_.clearRect(0,0,t,i),0==this.state_);else{var s=this.images_[0],h=this.images_[1],r=this.vertices_,a=this.verticesOuter_;if(r.length>=3){e.save(),e.beginPath();for(var n=0;n<r.length;n++){var o=r[n];0==n?e.moveTo(o.x,o.y):e.lineTo(o.x,o.y)}e.closePath(),e.clip(),h.drawOffsetScale(e,h.offset.x,h.offset.y,this.imageScale_,this.imageScale_),e.fillStyle="rgba(0, 0, 0, 0.3)",e.fill(),e.restore(),e.save(),e.beginPath();for(var n=0;n<r.length;n++){var o=r[n];0==n?e.moveTo(o.x+h.offset.x,o.y+2*h.offset.y):e.lineTo(o.x+h.offset.x,o.y+2*h.offset.y)}e.closePath(),e.clip(),e.globalCompositeOperation="source-atop",h.drawOffsetScale(e,h.offset.x,h.offset.y,this.imageScale_,this.imageScale_),e.restore();for(var n=0;n<r.length;n++){var _=r[n],g=r[(n+1)%r.length],l=new Point(g.x-_.x,g.y-_.y),c=Math.atan2(l.y,l.x);(0==l.x||0==l.y)&&(c=0==l.x&&0==l.y?0:0==l.x?l.y>0?Math.PI/2:-Math.PI/2:l.x>0?0:Math.PI);var u=l.getLength(),v=n<r.length/2?this.namiImages_[n%this.namiImages_.length]:this.namiImages_[(r.length-1-n)%this.namiImages_.length];e.save(),e.translate((_.x+g.x)/2,(_.y+g.y)/2),e.rotate(c),e.scale(u/v.img_.width,-u/v.img_.width),e.translate(-v.img_.width/2,-v.img_.height/2),v.drawOffsetScale(e,0,v.img_.height/2-3,1,1),e.restore()}e.save(),e.beginPath();for(var n=0;n<a.length;n++){var o=a[n];0==n?e.moveTo(o.x,o.y):e.lineTo(o.x,o.y)}e.closePath(),e.clip(),e.globalCompositeOperation="destination-over",e.fillStyle="rgba(255, 255, 255, 1)",e.fill(),e.restore();for(var n=0;n<a.length;n++){var _=a[n],g=a[(n+1)%a.length],l=new Point(g.x-_.x,g.y-_.y),c=Math.atan2(l.y,l.x);(0==l.x||0==l.y)&&(c=0==l.x&&0==l.y?0:0==l.x?l.y>0?Math.PI/2:-Math.PI/2:l.x>0?0:Math.PI);var u=l.getLength(),v=n<a.length/2?this.namiImages_[n%this.namiImages_.length]:this.namiImages_[(a.length-1-n)%this.namiImages_.length];e.save(),e.translate((_.x+g.x)/2,(_.y+g.y)/2),e.rotate(c),e.scale(u/v.img_.width,-u/v.img_.width),e.translate(-v.img_.width/2,-v.img_.height/2),e.rotate(Math.PI),e.translate(-v.img_.width,-v.img_.height),v.drawOffsetScale(e,0,v.img_.height/2-3,1,1),e.restore()}}e.save(),e.globalCompositeOperation="destination-over",s.drawOffsetScale(e,s.offset.x,s.offset.y,this.imageScale_,this.imageScale_),e.restore()}if(this.encodeTimer_>0&&(this.encodeTimer_%3==0&&(null!=this.gifEncoder_?(this.encodeTimer_==this.encodeDuration_?this.gifEncoder_.setDelay(1e3):this.gifEncoder_.setDelay(100),this.gifEncoder_.addFrame(e,!1)):null!=this.movEncoder_&&this.movEncoder_.add(e)),this.encodeTimer_--,this.encodeTimer_<=0&&(null!=this.gifEncoder_?(this.gifEncoder_.setDelay(1e3),this.gifEncoder_.addFrame(e,!1),this.gifEncoder_.finish()):null!=this.movEncoder_?this.movEncoder_.add(e):(this.encodeTimer_+=this.encodeDuration_,this.Callback("reset")))),null==this.gifEncoder_&&null==this.movEncoder_){this.debugDrawTimer_++,e.save();var m=Math.abs(Math.cos(this.debugDrawTimer_/30*Math.PI));e.strokeStyle="#FF0000",e.globalAlpha=.5,null!=this.mouseCurve_.curve&&(e.beginPath(),this.mouseCurve_.curve.draw(e),e.stroke()),e.globalAlpha=m,e.lineWidth=3;for(var f=0;f<this.mouseCurve_.points.length;f++){var d=this.mouseCurve_.points[f];e.beginPath(),e.moveTo(d.x-10,d.y),e.lineTo(d.x+10,d.y),e.moveTo(d.x,d.y-10),e.lineTo(d.x,d.y+10),e.stroke()}e.globalAlpha=1,e.restore(),e.save();var y=20,p=200,x=t-y-10,M=50;e.fillStyle="#FFFF00",e.fillRect(x,M+(1-this.radiusRatio_/2)*p,y,this.radiusRatio_/2*p),e.strokeStyle="#FFFF00",e.beginPath(),e.rect(x,M,y,p),e.closePath(),e.stroke(),e.restore()}}},paper.prototype.Callback=function(e){if("reset"===e)this.vertices_.length=0,this.verticesOuter_.length=0,this.verticesLeft_.length=0,this.verticesRight_.length=0,this.verticesDir_.length=0,this.verticesMouse_.length=0,this.mouseOff_=!1,this.mouseCurve_.create();else if("drawonce"===e)this.vertices;else if("record"===e)this.gifEncoder_=null,this.movEncoder_=null,this.gifEncoder_=new GIFEncoder,this.gifEncoder_.setRepeat(0),this.gifEncoder_.setDelay(100),this.gifEncoder_.setQuality(20),this.gifEncoder_.start(),this.encodeTimer_=this.encodeDuration_,this.Callback("reset");else if("recordMov"===e)this.gifEncoder_=null,this.movEncoder_=null,this.movEncoder_=new Whammy.Video(15),this.encodeTimer_=this.encodeDuration_,this.Callback("reset");else{if("recordEnd"===e)return this.encodeTimer_<=0?!0:!1;if("save"===e){if(null!=this.gifEncoder_){var t=this.gifEncoder_.stream().getData();return this.gifEncoder_=null,this.encodeTimer_+=this.encodeDuration_,this.Callback("reset"),t}if(null!=this.movEncoder_){var t=this.movEncoder_.compile();return this.movEncoder_=null,this.encodeTimer_+=this.encodeDuration_,this.Callback("reset"),t}return""}}};